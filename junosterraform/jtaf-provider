#!/usr/bin/env python3
import xml.etree.ElementTree as ElementTree
from copy import copy
import json
import argparse
import sys
from jinja2 import Template
import os
import shutil
import distutils.dir_util
import os
from importlib.resources import files, as_file
from junosterraform.jtaf_common import filter_json_using_xml, load_and_merge_xmls

 
def render_template_and_write(input_template: str, output_file: str, context: dict, description: str):
    with open(input_template) as f:
        tmpl = Template(f.read())
    rendered = tmpl.render(data=context).lstrip()
    with open(output_file, "w") as f:
        f.write(rendered)
    print(f"Updated {description}")


# Main Method
def main():
    # other arguments
    parser = argparse.ArgumentParser(exit_on_error=True)
    parser.add_argument('-j', '--json-schema', required=True, help='specify the json schema file')
    parser.add_argument('-x', '--xml-config', required=True, action='append', nargs="+", help='specify one or more XML config files to combine')
    parser.add_argument('-t', '--type', required=True, help='device type (i.e. vsrx, mx960, ex4200, etc)')
    args = parser.parse_args()

    # Merge XML files if multiple are provided 
    xml_files = [file for group in args.xml_config for file in group]
    xml_config = xml_files[0] if len(xml_files) == 1 else load_and_merge_xmls(xml_files)

    # Step 1: Filter the schema using the config
    resources = filter_json_using_xml(args.json_schema, xml_config)

    # Step 2: Render the template into Go code
    with as_file(files('junosterraform').joinpath('__init__.py')) as init_py:
        package_dir = os.path.dirname(init_py)
    templates_dir = f"{package_dir}/templates"
    with open(f"{templates_dir}/resource_config_provider.go.j2") as f:
        jinja2_source = f.read()
    tmpl = Template(jinja2_source)
    resource_config_provider_go = tmpl.render(data=resources).lstrip()

    # Step 3: Prepare new output directory based on type
    with as_file(files('terraform_provider').joinpath('__init__.py')) as init_py:
        go_dir = os.path.dirname(init_py)
    new_dir = f"terraform-provider-junos-{args.type}"

    # Step 4: copy the template go files into place
    distutils.dir_util.copy_tree(go_dir, new_dir)
    shutil.copytree(go_dir, new_dir, dirs_exist_ok=True)

    # Step 5: Save rendered Go file into new directory
    resource_config_provider_go_fullpath = os.path.join(new_dir, "resource_config_provider.go")
    with open(resource_config_provider_go_fullpath, "w") as f:
        f.write(resource_config_provider_go)
    print(f"Plugin created in {os.path.relpath(resource_config_provider_go_fullpath)}\n")

    # Step 6-8: Update provider.go, go.mod, and config.go with correct type using a loop
    files_to_update = [
        ("provider.go.j2", "provider.go"),
        ("go.mod.j2", "go.mod"),
        ("config.go.j2", "config.go"),
    ]
    for template_name, output_name in files_to_update:
        with open(f"{templates_dir}/{template_name}") as f:
            jinja2_source = f.read()
        tmpl = Template(jinja2_source)
        rendered = tmpl.render(data={"device_type": args.type}).lstrip()
        output_path = os.path.join(new_dir, output_name)
        with open(output_path, "w") as f:
            f.write(rendered)
        print(f"Updated {output_name} with type junos-{args.type}")

    # Step 7: Add trimmed_schema.json to new directory
    trimmed_schema_path = os.path.join(new_dir, "trimmed_schema.json")
    with open(trimmed_schema_path, "w") as f:
        json.dump(resources, f, indent=2)

# run main()
if __name__ == "__main__":
    main()